---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: envoy-gateway
spec:
  chartRef:
    kind: OCIRepository
    name: envoy-gateway
  interval: 1h
  values:
    global:
      imageRegistry: mirror.gcr.io
    deployment:
      envoyGateway:
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            memory: 2Gi
    config:
      envoyGateway:
        provider:
          type: Kubernetes
          kubernetes:
            deploy:
              type: GatewayNamespace
        extensionApis:
          enableBackend: true
  postRenderers:
    - kustomize:
        patches:
          - target:
              kind: Deployment
              name: envoy-gateway
            patch: |
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: envoy-gateway
              spec:
                template:
                  spec:
                    containers:
                      - name: envoy-gateway
                        livenessProbe:
                          httpGet:
                            path: /healthz
                            port: 8081
                          initialDelaySeconds: 30
                          periodSeconds: 30
                          timeoutSeconds: 5
                          failureThreshold: 6
                        readinessProbe:
                          httpGet:
                            path: /readyz
                            port: 8081
                          initialDelaySeconds: 10
                          periodSeconds: 15
                          timeoutSeconds: 5
                          failureThreshold: 5
