---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: homepage-stats
  namespace: default
spec:
  # Run every 15 minutes
  schedule: "*/15 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: homepage-stats
        spec:
          serviceAccountName: homepage-stats
          restartPolicy: OnFailure
          initContainers:
            - name: copy-scripts
              image: busybox:latest
              command:
                - sh
                - -c
                - |
                  # Copy scripts from ConfigMap
                  if [ -f /scripts/discover-services.py ]; then
                    cp /scripts/discover-services.py /shared/discover-services.py
                    chmod +x /shared/discover-services.py
                  else
                    echo "Warning: discover-services.py not found in ConfigMap"
                  fi
                  
                  if [ -f /scripts/fetch-stats.py ]; then
                    cp /scripts/fetch-stats.py /shared/fetch-stats.py
                    chmod +x /shared/fetch-stats.py
                  else
                    echo "Warning: fetch-stats.py not found in ConfigMap"
                  fi
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                  readOnly: true
                - name: shared
                  mountPath: /shared
          containers:
            - name: stats-updater
              image: python:3.11-slim
              command:
                - /bin/bash
                - -c
                - |
                  set -e
                  
                  # Install kubectl
                  curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                  chmod +x kubectl
                  mv kubectl /usr/local/bin/
                  
                  # Install Python dependencies
                  pip install --no-cache-dir requests pyyaml kubernetes
                  
                  # Copy scripts from shared volume
                  cp /shared/discover-services.py /tmp/discover-services.py
                  cp /shared/fetch-stats.py /tmp/fetch-stats.py
                  chmod +x /tmp/discover-services.py /tmp/fetch-stats.py
                  
                  # Use in-cluster Kubernetes config
                  export KUBECONFIG=/var/run/secrets/kubernetes.io/serviceaccount
                  
                  # Run discovery script
                  echo "Running service discovery..."
                  python3 /tmp/discover-services.py /app/config/services.yaml || {
                    echo "Discovery failed, continuing..."
                    exit 0
                  }
                  
                  # Run stats fetching
                  echo "Fetching stats..."
                  python3 /tmp/fetch-stats.py /app/config/widgets.yaml || {
                    echo "Stats fetch failed, continuing..."
                    exit 0
                  }
                  
                  echo "Homepage config update completed successfully"
              env:
                # Service URLs - will be read from HTTPRoutes by discovery script
                - name: SONARR_URL
                  value: "https://sonarr.iacob.uk"
                - name: RADARR_URL
                  value: "https://radarr.iacob.uk"
                - name: LIDARR_URL
                  value: "https://lidarr.iacob.uk"
                - name: READARR_URL
                  value: "https://readarr.iacob.uk"
                - name: BAZARR_URL
                  value: "https://bazarr.iacob.uk"
                - name: PROWLARR_URL
                  value: "https://prowlarr.iacob.uk"
                - name: JELLYFIN_URL
                  value: "https://jellyfin.iacob.uk"
                - name: IMMICH_URL
                  value: "https://photos.iacob.uk"
                - name: CALIBRE_URL
                  value: "https://calibre.iacob.uk"
                - name: QBITTORRENT_URL
                  value: "https://qbittorrent.iacob.uk"
                - name: SABNZBD_URL
                  value: "https://sabnzbd.iacob.uk"
                # API keys from secrets
                - name: SONARR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: homepage-stats-secret
                      key: sonarr-api-key
                      optional: true
                - name: RADARR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: homepage-stats-secret
                      key: radarr-api-key
                      optional: true
                - name: LIDARR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: homepage-stats-secret
                      key: lidarr-api-key
                      optional: true
                - name: READARR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: homepage-stats-secret
                      key: readarr-api-key
                      optional: true
                - name: BAZARR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: homepage-stats-secret
                      key: bazarr-api-key
                      optional: true
                - name: PROWLARR_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: homepage-stats-secret
                      key: prowlarr-api-key
                      optional: true
                - name: IMMICH_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: homepage-stats-secret
                      key: immich-api-key
                      optional: true
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                  readOnly: true
                - name: shared
                  mountPath: /shared
                - name: config
                  mountPath: /app/config
              resources:
                requests:
                  cpu: 100m
                  memory: 256Mi
                limits:
                  cpu: 500m
                  memory: 512Mi
          volumes:
            - name: scripts
              configMap:
                name: homepage-stats-scripts
                defaultMode: 0755
            - name: shared
              emptyDir: {}
            - name: config
              persistentVolumeClaim:
                claimName: homepage
